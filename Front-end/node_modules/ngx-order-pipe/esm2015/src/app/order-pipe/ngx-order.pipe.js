import * as tslib_1 from "tslib";
var OrderPipe_1;
import { Pipe } from "@angular/core";
let OrderPipe = OrderPipe_1 = class OrderPipe {
    /**
     * Check if a value is a string
     *
     * @param value
     */
    static isString(value) {
        return typeof value === "string" || value instanceof String;
    }
    /**
     * Sorts values ignoring the case
     *
     * @param a
     * @param b
     */
    static caseInsensitiveSort(a, b) {
        if (OrderPipe_1.isString(a) && OrderPipe_1.isString(b)) {
            return a.localeCompare(b);
        }
        return OrderPipe_1.defaultCompare(a, b);
    }
    /**
     * Default compare method
     *
     * @param a
     * @param b
     */
    static defaultCompare(a, b) {
        if (a && a instanceof Date) {
            a = a.getTime();
        }
        if (b && b instanceof Date) {
            b = b.getTime();
        }
        if (a === b) {
            return 0;
        }
        if (a == null) {
            return 1;
        }
        if (b == null) {
            return -1;
        }
        return a > b ? 1 : -1;
    }
    /**
     * Parse expression, split into items
     * @param expression
     * @returns {string[]}
     */
    static parseExpression(expression) {
        expression = expression.replace(/\[(\w+)\]/g, ".$1");
        expression = expression.replace(/^\./, "");
        return expression.split(".");
    }
    /**
     * Get value by expression
     *
     * @param object
     * @param expression
     * @returns {any}
     */
    static getValue(object, expression) {
        for (let i = 0, n = expression.length; i < n; ++i) {
            if (!object) {
                return;
            }
            const k = expression[i];
            if (!(k in object)) {
                return;
            }
            if (typeof object[k] === "function") {
                object = object[k]();
            }
            else {
                object = object[k];
            }
        }
        return object;
    }
    /**
     * Set value by expression
     *
     * @param object
     * @param value
     * @param expression
     */
    static setValue(object, value, expression) {
        let i;
        for (i = 0; i < expression.length - 1; i++) {
            object = object[expression[i]];
        }
        object[expression[i]] = value;
    }
    transform(value, expression, reverse, isCaseInsensitive = false, comparator) {
        if (!value) {
            return value;
        }
        if (Array.isArray(expression)) {
            return this.multiExpressionTransform(value, expression.slice(), reverse, isCaseInsensitive, comparator);
        }
        if (Array.isArray(value)) {
            return this.sortArray(value.slice(), expression, reverse, isCaseInsensitive, comparator);
        }
        if (typeof value === "object") {
            return this.transformObject(Object.assign({}, value), expression, reverse, isCaseInsensitive, comparator);
        }
        return value;
    }
    /**
     * Sort array
     *
     * @param value
     * @param expression
     * @param reverse
     * @param isCaseInsensitive
     * @param comparator
     * @returns {any[]}
     */
    sortArray(value, expression, reverse, isCaseInsensitive, comparator) {
        const isDeepLink = expression && expression.indexOf(".") !== -1;
        if (isDeepLink) {
            expression = OrderPipe_1.parseExpression(expression);
        }
        let compareFn;
        if (comparator && typeof comparator === "function") {
            compareFn = comparator;
        }
        else {
            compareFn = isCaseInsensitive
                ? OrderPipe_1.caseInsensitiveSort
                : OrderPipe_1.defaultCompare;
        }
        const array = value.sort((a, b) => {
            if (!expression) {
                return compareFn(a, b);
            }
            if (!isDeepLink) {
                if (a && b) {
                    return compareFn(a[expression], b[expression]);
                }
                return compareFn(a, b);
            }
            return compareFn(OrderPipe_1.getValue(a, expression), OrderPipe_1.getValue(b, expression));
        });
        if (reverse) {
            return array.reverse();
        }
        return array;
    }
    /**
     * Transform Object
     *
     * @param value
     * @param expression
     * @param reverse
     * @param isCaseInsensitive
     * @param comparator
     * @returns {any[]}
     */
    transformObject(value, expression, reverse, isCaseInsensitive, comparator) {
        const parsedExpression = OrderPipe_1.parseExpression(expression);
        let lastPredicate = parsedExpression.pop();
        let oldValue = OrderPipe_1.getValue(value, parsedExpression);
        if (!Array.isArray(oldValue)) {
            parsedExpression.push(lastPredicate);
            lastPredicate = null;
            oldValue = OrderPipe_1.getValue(value, parsedExpression);
        }
        if (!oldValue) {
            return value;
        }
        OrderPipe_1.setValue(value, this.transform(oldValue, lastPredicate, reverse, isCaseInsensitive), parsedExpression);
        return value;
    }
    /**
     * Apply multiple expressions
     *
     * @param value
     * @param {any[]} expressions
     * @param {boolean} reverse
     * @param {boolean} isCaseInsensitive
     * @param {Function} comparator
     * @returns {any}
     */
    multiExpressionTransform(value, expressions, reverse, isCaseInsensitive = false, comparator) {
        return expressions.reverse().reduce((result, expression) => {
            return this.transform(result, expression, reverse, isCaseInsensitive, comparator);
        }, value);
    }
};
OrderPipe = OrderPipe_1 = tslib_1.__decorate([
    Pipe({
        name: "orderBy",
        pure: false,
    })
], OrderPipe);
export { OrderPipe };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LW9yZGVyLnBpcGUuanMiLCJzb3VyY2VSb290IjoiL1VzZXJzL3ZhZGltZGV6L0RvY3VtZW50cy9teV9kZXYvbmd4LW9yZGVyLXBpcGUvIiwic291cmNlcyI6WyJzcmMvYXBwL29yZGVyLXBpcGUvbmd4LW9yZGVyLnBpcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxPQUFPLEVBQUUsSUFBSSxFQUFpQixNQUFNLGVBQWUsQ0FBQztBQU1wRCxJQUFhLFNBQVMsaUJBQXRCLE1BQWEsU0FBUztJQUNwQjs7OztPQUlHO0lBQ0gsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFVO1FBQ3hCLE9BQU8sT0FBTyxLQUFLLEtBQUssUUFBUSxJQUFJLEtBQUssWUFBWSxNQUFNLENBQUM7SUFDOUQsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQU0sRUFBRSxDQUFNO1FBQ3ZDLElBQUksV0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxXQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ2xELE9BQU8sQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMzQjtRQUNELE9BQU8sV0FBUyxDQUFDLGNBQWMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFNLEVBQUUsQ0FBTTtRQUNsQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksSUFBSSxFQUFFO1lBQzFCLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7U0FDakI7UUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksSUFBSSxFQUFFO1lBQzFCLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7U0FDakI7UUFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDWCxPQUFPLENBQUMsQ0FBQztT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b0JBQTZCLEtBQUssRUFDbEMsVUFBcUI7UUFFckIsT0FBTyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBVyxFQUFFLFVBQWUsRUFBRSxFQUFFO1lBQ25FLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FDbkIsTUFBTSxFQUNOLFVBQVUsRUFDVixPQUFPLEVBQ1AsaUJBQWlCLEVBQ2pCLFVBQVUsQ0FDWCxDQUFDO1FBQ0osQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ1osQ0FBQztDQUNGLENBQUE7QUE5UVksU0FBUztJQUpyQixJQUFJLENBQUM7UUFDSixJQUFJLEVBQUUsU0FBUztRQUNmLElBQUksRUFBRSxLQUFLO0tBQ1osQ0FBQztHQUNXLFNBQVMsQ0E4UXJCO1NBOVFZLFNBQVMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQaXBlLCBQaXBlVHJhbnNmb3JtIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcblxuQFBpcGUoe1xuICBuYW1lOiBcIm9yZGVyQnlcIixcbiAgcHVyZTogZmFsc2UsXG59KVxuZXhwb3J0IGNsYXNzIE9yZGVyUGlwZSBpbXBsZW1lbnRzIFBpcGVUcmFuc2Zvcm0ge1xuICAvKipcbiAgICogQ2hlY2sgaWYgYSB2YWx1ZSBpcyBhIHN0cmluZ1xuICAgKlxuICAgKiBAcGFyYW0gdmFsdWVcbiAgICovXG4gIHN0YXRpYyBpc1N0cmluZyh2YWx1ZTogYW55KSB7XG4gICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gXCJzdHJpbmdcIiB8fCB2YWx1ZSBpbnN0YW5jZW9mIFN0cmluZztcbiAgfVxuXG4gIC8qKlxuICAgKiBTb3J0cyB2YWx1ZXMgaWdub3JpbmcgdGhlIGNhc2VcbiAgICpcbiAgICogQHBhcmFtIGFcbiAgICogQHBhcmFtIGJcbiAgICovXG4gIHN0YXRpYyBjYXNlSW5zZW5zaXRpdmVTb3J0KGE6IGFueSwgYjogYW55KSB7XG4gICAgaWYgKE9yZGVyUGlwZS5pc1N0cmluZyhhKSAmJiBPcmRlclBpcGUuaXNTdHJpbmcoYikpIHtcbiAgICAgIHJldHVybiBhLmxvY2FsZUNvbXBhcmUoYik7XG4gICAgfVxuICAgIHJldHVybiBPcmRlclBpcGUuZGVmYXVsdENvbXBhcmUoYSwgYik7XG4gIH1cblxuICAvKipcbiAgICogRGVmYXVsdCBjb21wYXJlIG1ldGhvZFxuICAgKlxuICAgKiBAcGFyYW0gYVxuICAgKiBAcGFyYW0gYlxuICAgKi9cbiAgc3RhdGljIGRlZmF1bHRDb21wYXJlKGE6IGFueSwgYjogYW55KSB7XG4gICAgaWYgKGEgJiYgYSBpbnN0YW5jZW9mIERhdGUpIHtcbiAgICAgIGEgPSBhLmdldFRpbWUoKTtcbiAgICB9XG4gICAgaWYgKGIgJiYgYiBpbnN0YW5jZW9mIERhdGUpIHtcbiAgICAgIGIgPSBiLmdldFRpbWUoKTtcbiAgICB9XG5cbiAgICBpZiAoYSA9PT0gYikge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICAgIGlmIChhID09IG51bGwpIHtcbiAgICAgIHJldHVybiAxO1xuICAgIH1cbiAgICBpZiAoYiA9PSBudWxsKSB7XG4gICAgICByZXR1cm4gLTE7XG4gICAgfVxuICAgIHJldHVybiBhID4gYiA/IDEgOiAtMTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXJzZSBleHByZXNzaW9uLCBzcGxpdCBpbnRvIGl0ZW1zXG4gICAqIEBwYXJhbSBleHByZXNzaW9uXG4gICAqIEByZXR1cm5zIHtzdHJpbmdbXX1cbiAgICovXG4gIHN0YXRpYyBwYXJzZUV4cHJlc3Npb24oZXhwcmVzc2lvbjogc3RyaW5nKTogc3RyaW5nW10ge1xuICAgIGV4cHJlc3Npb24gPSBleHByZXNzaW9uLnJlcGxhY2UoL1xcWyhcXHcrKVxcXS9nLCBcIi4kMVwiKTtcbiAgICBleHByZXNzaW9uID0gZXhwcmVzc2lvbi5yZXBsYWNlKC9eXFwuLywgXCJcIik7XG4gICAgcmV0dXJuIGV4cHJlc3Npb24uc3BsaXQoXCIuXCIpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB2YWx1ZSBieSBleHByZXNzaW9uXG4gICAqXG4gICAqIEBwYXJhbSBvYmplY3RcbiAgICogQHBhcmFtIGV4cHJlc3Npb25cbiAgICogQHJldHVybnMge2FueX1cbiAgICovXG4gIHN0YXRpYyBnZXRWYWx1ZShvYmplY3Q6IGFueSwgZXhwcmVzc2lvbjogc3RyaW5nW10pIHtcbiAgICBmb3IgKGxldCBpID0gMCwgbiA9IGV4cHJlc3Npb24ubGVuZ3RoOyBpIDwgbjsgKytpKSB7XG4gICAgICBpZiAoIW9iamVjdCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCBrID0gZXhwcmVzc2lvbltpXTtcbiAgICAgIGlmICghKGsgaW4gb2JqZWN0KSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIG9iamVjdFtrXSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIG9iamVjdCA9IG9iamVjdFtrXSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb2JqZWN0ID0gb2JqZWN0W2tdO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBvYmplY3Q7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHZhbHVlIGJ5IGV4cHJlc3Npb25cbiAgICpcbiAgICogQHBhcmFtIG9iamVjdFxuICAgKiBAcGFyYW0gdmFsdWVcbiAgICogQHBhcmFtIGV4cHJlc3Npb25cbiAgICovXG4gIHN0YXRpYyBzZXRWYWx1ZShvYmplY3Q6IGFueSwgdmFsdWU6IGFueSwgZXhwcmVzc2lvbjogc3RyaW5nW10pIHtcbiAgICBsZXQgaTtcbiAgICBmb3IgKGkgPSAwOyBpIDwgZXhwcmVzc2lvbi5sZW5ndGggLSAxOyBpKyspIHtcbiAgICAgIG9iamVjdCA9IG9iamVjdFtleHByZXNzaW9uW2ldXTtcbiAgICB9XG5cbiAgICBvYmplY3RbZXhwcmVzc2lvbltpXV0gPSB2YWx1ZTtcbiAgfVxuXG4gIHRyYW5zZm9ybShcbiAgICB2YWx1ZTogYW55IHwgYW55W10sXG4gICAgZXhwcmVzc2lvbj86IGFueSxcbiAgICByZXZlcnNlPzogYm9vbGVhbixcbiAgICBpc0Nhc2VJbnNlbnNpdGl2ZTogYm9vbGVhbiA9IGZhbHNlLFxuICAgIGNvbXBhcmF0b3I/OiBGdW5jdGlvblxuICApOiBhbnkge1xuICAgIGlmICghdmFsdWUpIHtcbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBpZiAoQXJyYXkuaXNBcnJheShleHByZXNzaW9uKSkge1xuICAgICAgcmV0dXJuIHRoaXMubXVsdGlFeHByZXNzaW9uVHJhbnNmb3JtKFxuICAgICAgICB2YWx1ZSxcbiAgICAgICAgZXhwcmVzc2lvbi5zbGljZSgpLFxuICAgICAgICByZXZlcnNlLFxuICAgICAgICBpc0Nhc2VJbnNlbnNpdGl2ZSxcbiAgICAgICAgY29tcGFyYXRvclxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLnNvcnRBcnJheShcbiAgICAgICAgdmFsdWUuc2xpY2UoKSxcbiAgICAgICAgZXhwcmVzc2lvbixcbiAgICAgICAgcmV2ZXJzZSxcbiAgICAgICAgaXNDYXNlSW5zZW5zaXRpdmUsXG4gICAgICAgIGNvbXBhcmF0b3JcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJvYmplY3RcIikge1xuICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtT2JqZWN0KFxuICAgICAgICBPYmplY3QuYXNzaWduKHt9LCB2YWx1ZSksXG4gICAgICAgIGV4cHJlc3Npb24sXG4gICAgICAgIHJldmVyc2UsXG4gICAgICAgIGlzQ2FzZUluc2Vuc2l0aXZlLFxuICAgICAgICBjb21wYXJhdG9yXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTb3J0IGFycmF5XG4gICAqXG4gICAqIEBwYXJhbSB2YWx1ZVxuICAgKiBAcGFyYW0gZXhwcmVzc2lvblxuICAgKiBAcGFyYW0gcmV2ZXJzZVxuICAgKiBAcGFyYW0gaXNDYXNlSW5zZW5zaXRpdmVcbiAgICogQHBhcmFtIGNvbXBhcmF0b3JcbiAgICogQHJldHVybnMge2FueVtdfVxuICAgKi9cbiAgcHJpdmF0ZSBzb3J0QXJyYXkoXG4gICAgdmFsdWU6IGFueVtdLFxuICAgIGV4cHJlc3Npb24/OiBhbnksXG4gICAgcmV2ZXJzZT86IGJvb2xlYW4sXG4gICAgaXNDYXNlSW5zZW5zaXRpdmU/OiBib29sZWFuLFxuICAgIGNvbXBhcmF0b3I/OiBGdW5jdGlvblxuICApOiBhbnlbXSB7XG4gICAgY29uc3QgaXNEZWVwTGluayA9IGV4cHJlc3Npb24gJiYgZXhwcmVzc2lvbi5pbmRleE9mKFwiLlwiKSAhPT0gLTE7XG5cbiAgICBpZiAoaXNEZWVwTGluaykge1xuICAgICAgZXhwcmVzc2lvbiA9IE9yZGVyUGlwZS5wYXJzZUV4cHJlc3Npb24oZXhwcmVzc2lvbik7XG4gICAgfVxuXG4gICAgbGV0IGNvbXBhcmVGbjogRnVuY3Rpb247XG5cbiAgICBpZiAoY29tcGFyYXRvciAmJiB0eXBlb2YgY29tcGFyYXRvciA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICBjb21wYXJlRm4gPSBjb21wYXJhdG9yO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb21wYXJlRm4gPSBpc0Nhc2VJbnNlbnNpdGl2ZVxuICAgICAgICA/IE9yZGVyUGlwZS5jYXNlSW5zZW5zaXRpdmVTb3J0XG4gICAgICAgIDogT3JkZXJQaXBlLmRlZmF1bHRDb21wYXJlO1xuICAgIH1cblxuICAgIGNvbnN0IGFycmF5OiBhbnlbXSA9IHZhbHVlLnNvcnQoKGE6IGFueSwgYjogYW55KTogbnVtYmVyID0+IHtcbiAgICAgIGlmICghZXhwcmVzc2lvbikge1xuICAgICAgICByZXR1cm4gY29tcGFyZUZuKGEsIGIpO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWlzRGVlcExpbmspIHtcbiAgICAgICAgaWYgKGEgJiYgYikge1xuICAgICAgICAgIHJldHVybiBjb21wYXJlRm4oYVtleHByZXNzaW9uXSwgYltleHByZXNzaW9uXSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNvbXBhcmVGbihhLCBiKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGNvbXBhcmVGbihcbiAgICAgICAgT3JkZXJQaXBlLmdldFZhbHVlKGEsIGV4cHJlc3Npb24pLFxuICAgICAgICBPcmRlclBpcGUuZ2V0VmFsdWUoYiwgZXhwcmVzc2lvbilcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpZiAocmV2ZXJzZSkge1xuICAgICAgcmV0dXJuIGFycmF5LnJldmVyc2UoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXJyYXk7XG4gIH1cblxuICAvKipcbiAgICogVHJhbnNmb3JtIE9iamVjdFxuICAgKlxuICAgKiBAcGFyYW0gdmFsdWVcbiAgICogQHBhcmFtIGV4cHJlc3Npb25cbiAgICogQHBhcmFtIHJldmVyc2VcbiAgICogQHBhcmFtIGlzQ2FzZUluc2Vuc2l0aXZlXG4gICAqIEBwYXJhbSBjb21wYXJhdG9yXG4gICAqIEByZXR1cm5zIHthbnlbXX1cbiAgICovXG4gIHByaXZhdGUgdHJhbnNmb3JtT2JqZWN0KFxuICAgIHZhbHVlOiBhbnkgfCBhbnlbXSxcbiAgICBleHByZXNzaW9uPzogYW55LFxuICAgIHJldmVyc2U/OiBib29sZWFuLFxuICAgIGlzQ2FzZUluc2Vuc2l0aXZlPzogYm9vbGVhbixcbiAgICBjb21wYXJhdG9yPzogRnVuY3Rpb25cbiAgKTogYW55IHtcbiAgICBjb25zdCBwYXJzZWRFeHByZXNzaW9uID0gT3JkZXJQaXBlLnBhcnNlRXhwcmVzc2lvbihleHByZXNzaW9uKTtcbiAgICBsZXQgbGFzdFByZWRpY2F0ZSA9IHBhcnNlZEV4cHJlc3Npb24ucG9wKCk7XG4gICAgbGV0IG9sZFZhbHVlID0gT3JkZXJQaXBlLmdldFZhbHVlKHZhbHVlLCBwYXJzZWRFeHByZXNzaW9uKTtcblxuICAgIGlmICghQXJyYXkuaXNBcnJheShvbGRWYWx1ZSkpIHtcbiAgICAgIHBhcnNlZEV4cHJlc3Npb24ucHVzaChsYXN0UHJlZGljYXRlKTtcbiAgICAgIGxhc3RQcmVkaWNhdGUgPSBudWxsO1xuICAgICAgb2xkVmFsdWUgPSBPcmRlclBpcGUuZ2V0VmFsdWUodmFsdWUsIHBhcnNlZEV4cHJlc3Npb24pO1xuICAgIH1cblxuICAgIGlmICghb2xkVmFsdWUpIHtcbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBPcmRlclBpcGUuc2V0VmFsdWUoXG4gICAgICB2YWx1ZSxcbiAgICAgIHRoaXMudHJhbnNmb3JtKG9sZFZhbHVlLCBsYXN0UHJlZGljYXRlLCByZXZlcnNlLCBpc0Nhc2VJbnNlbnNpdGl2ZSksXG4gICAgICBwYXJzZWRFeHByZXNzaW9uXG4gICAgKTtcbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICAvKipcbiAgICogQXBwbHkgbXVsdGlwbGUgZXhwcmVzc2lvbnNcbiAgICpcbiAgICogQHBhcmFtIHZhbHVlXG4gICAqIEBwYXJhbSB7YW55W119IGV4cHJlc3Npb25zXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gcmV2ZXJzZVxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzQ2FzZUluc2Vuc2l0aXZlXG4gICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbXBhcmF0b3JcbiAgICogQHJldHVybnMge2FueX1cbiAgICovXG4gIHByaXZhdGUgbXVsdGlFeHByZXNzaW9uVHJhbnNmb3JtKFxuICAgIHZhbHVlOiBhbnksXG4gICAgZXhwcmVzc2lvbnM6IGFueVtdLFxuICAgIHJldmVyc2U6IGJvb2xlYW4sXG4gICAgaXNDYXNlSW5zZW5zaXRpdmU6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICBjb21wYXJhdG9yPzogRnVuY3Rpb25cbiAgKTogYW55IHtcbiAgICByZXR1cm4gZXhwcmVzc2lvbnMucmV2ZXJzZSgpLnJlZHVjZSgocmVzdWx0OiBhbnksIGV4cHJlc3Npb246IGFueSkgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtKFxuICAgICAgICByZXN1bHQsXG4gICAgICAgIGV4cHJlc3Npb24sXG4gICAgICAgIHJldmVyc2UsXG4gICAgICAgIGlzQ2FzZUluc2Vuc2l0aXZlLFxuICAgICAgICBjb21wYXJhdG9yXG4gICAgICApO1xuICAgIH0sIHZhbHVlKTtcbiAgfVxufVxuIl19